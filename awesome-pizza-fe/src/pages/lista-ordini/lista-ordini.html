<div class="orders-container">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <mat-icon>list_alt</mat-icon>
                Lista Ordini
            </h1>
            <p class="page-subtitle">Gestisci e monitora tutti gli ordini</p>
        </div>
        <div class="header-actions">
            <button mat-raised-button color="primary" class="add-order-btn" routerLink="/">
                <mat-icon>home</mat-icon>
                Home
            </button>
            <button mat-raised-button color="primary" class="add-order-btn" routerLink="/nuovo-ordine">
                <mat-icon>add</mat-icon>
                Nuovo Ordine
            </button>
        </div>
    </div>

    <div class="page-sub-header">
        <div class="sub-header-actions">
            <button mat-raised-button  class="status-order-btn" (click)="onChangeFilterState('ALL')">
                Tutti
            </button>
            <button mat-raised-button  class="status-order-btn status-in-attesa" (click)="onChangeFilterState('IN ATTESA')">
                In Attesa
            </button>
        </div>

        <div class="sub-header-actions">
            <button mat-raised-button class="status-order-btn status-in-preparazione" (click)="onChangeFilterState('IN PREPARAZIONE')">
                In Preparazione
            </button>
            <button mat-raised-button class="status-order-btn status-in-consegna" (click)="onChangeFilterState('IN CONSEGNA')">
                In Consegna
            </button>
        </div>

        <div class="sub-header-actions">
            <button mat-raised-button class="status-order-btn status-consegnato" (click)="onChangeFilterState('CONSEGNATO')">
                Consegnato
            </button>
            <button mat-raised-button class="status-order-btn status-annullato" (click)="onChangeFilterState('ANNULLATO')">
                Annullato
            </button>
        </div>
    </div>


    <mat-card class="table-card">
        <mat-card-content>
            <div class="table-wrapper">
                <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="orders-table">

                    <!-- Colonne dinamiche -->
                    @for (column of header; track column) {
                        <ng-container matColumnDef="{{column.id}}">
                            <th mat-header-cell *matHeaderCellDef>{{ column.name }}</th>
                            <td mat-cell *matCellDef="let element">
                                @if (column.id === 'orderState') {
                                    <span class="status-badge" [class]="'status-' + getStatusClass(element.orderState)">
                    {{ element.orderState }}
                  </span>
                                } @else {
                                    {{ element[column.id] }}
                                }
                            </td>
                        </ng-container>
                    }

                    <!-- Colonna Azioni -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>Azioni</th>
                        <td mat-cell *matCellDef="let element" (click)="$event.stopPropagation()">
                            <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Menu azioni">
                                <mat-icon>more_vert</mat-icon>
                            </button>

                            <mat-menu #menu="matMenu">
                                @if (element.orderState === 'IN ATTESA') {
                                    <button mat-menu-item (click)="onTakeCharge(element)">
                                        <mat-icon>play_arrow</mat-icon>
                                        <span>Prendi in carico</span>
                                    </button>
                                }

                                @if (element.orderState === 'IN PREPARAZIONE') {
                                    <button mat-menu-item (click)="onStartDelivery(element)">
                                        <mat-icon>local_shipping</mat-icon>
                                        <span>Avvia consegna</span>
                                    </button>
                                }

                                @if (element.orderState === 'IN CONSEGNA') {
                                    <button mat-menu-item (click)="onComplete(element)">
                                        <mat-icon>check_circle</mat-icon>
                                        <span>Segna come consegnato</span>
                                    </button>
                                }

                                @if (element.orderState === 'IN ATTESA' || element.orderState === 'IN PREPARAZIONE') {
                                    <mat-divider></mat-divider>
                                    <button mat-menu-item (click)="onCancel(element)" class="cancel-action">
                                        <mat-icon>cancel</mat-icon>
                                        <span>Annulla ordine</span>
                                    </button>
                                }
                            </mat-menu>
                        </td>
                    </ng-container>

                    <!-- Colonna Expand -->
                    <ng-container matColumnDef="expand">
                        <th mat-header-cell *matHeaderCellDef aria-label="row actions"></th>
                        <td mat-cell *matCellDef="let element">
                            <button mat-icon-button
                                    aria-label="expand row"
                                    (click)="toggle(element); $event.stopPropagation()"
                                    class="expand-button"
                                    [class.expanded]="isExpanded(element)">
                                <mat-icon>expand_more</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <!-- Dettagli Espansi -->
                    <ng-container matColumnDef="expandedDetail">
                        <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length">
                            <div class="detail-wrapper" [class.expanded]="isExpanded(element)">
                                <div class="detail-content">
                                    @if (orderDetails) {
                                        <div class="products-section">
                                            <h3 class="section-title">
                                                <mat-icon>shopping_basket</mat-icon>
                                                Prodotti dell'ordine
                                            </h3>

                                            <div class="products-grid">
                                                @for (product of orderDetails; track product.productId) {
                                                    <mat-card class="product-detail-card">
                                                        <div class="product-header">
                              <span class="product-name"
                                    (click)="onClickProductDetails(product.productId)">
                                {{ product.productName }}
                              </span>
                                                            <span class="product-quantity">
                                <mat-icon>shopping_cart</mat-icon>
                                x{{ product.quantity }}
                              </span>
                                                        </div>
                                                        @if (product.note && product.note !== '') {
                                                            <div class="product-note">
                                                                <mat-icon>note</mat-icon>
                                                                <span>{{ product.note }}</span>
                                                            </div>
                                                        }
                                                    </mat-card>
                                                }
                                            </div>
                                        </div>
                                    } @else {
                                        <div class="loading-detail">
                                            <mat-spinner diameter="40"></mat-spinner>
                                            <p>Caricamento dettagli...</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Header e Righe -->
                    <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
                    <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
                        class="order-row"
                        [class.expanded-row]="isExpanded(element)"
                        (click)="toggle(element)">
                    </tr>
                    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
                </table>

                @if (dataSource.length === 0) {
                    <div class="empty-state">
                        <mat-icon>inbox</mat-icon>
                        <h3>Nessun ordine presente</h3>

                        <!--<p>Inizia creando il tuo primo ordine</p>
                        <button mat-raised-button color="primary" routerLink="/nuovo-oordine">
                            <mat-icon>add</mat-icon>
                            Crea Ordine
                        </button>-->
                    </div>
                }
            </div>
        </mat-card-content>
    </mat-card>
</div>
